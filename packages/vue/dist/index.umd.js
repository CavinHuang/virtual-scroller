(function(m,t){typeof exports=="object"&&typeof module<"u"?t(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],t):(m=typeof globalThis<"u"?globalThis:m||self,t(m.Virtual={},m.Vue))})(this,function(m,t){"use strict";var se=Object.defineProperty;var ne=(m,t,R)=>t in m?se(m,t,{enumerable:!0,configurable:!0,writable:!0,value:R}):m[t]=R;var z=(m,t,R)=>(ne(m,typeof t!="symbol"?t+"":t,R),R);const R=/scroll|auto|overlay/i,w=window||void 0;function L(e){return e.tagName!=="HTML"&&e.tagName!=="BODY"&&e.nodeType===1}function v(e,s=w){let o=e;for(;o&&o!==s&&L(o);){const{overflowY:n}=window.getComputedStyle(o);if(R.test(n))return o;o=o.parentNode}return s}function K(e,s=w){const o=t.ref();return t.onMounted(()=>{e.value&&(o.value=v(e.value,s))}),o}function A(e,s){return e>s?"horizontal":s>e?"vertical":""}function $(){const e=t.ref(0),s=t.ref(0),o=t.ref(0),n=t.ref(0),a=t.ref(0),u=t.ref(0),d=t.ref(""),p=()=>d.value==="vertical",S=()=>d.value==="horizontal",g=()=>{o.value=0,n.value=0,a.value=0,u.value=0,d.value=""};return{move:l=>{const T=l.touches[0];o.value=(T.clientX<0?0:T.clientX)-e.value,n.value=T.clientY-s.value,a.value=Math.abs(o.value),u.value=Math.abs(n.value);const I=10;(!d.value||a.value<I&&u.value<I)&&(d.value=A(a.value,u.value))},start:l=>{g(),e.value=l.touches[0].clientX,s.value=l.touches[0].clientY},reset:g,startX:e,startY:s,deltaX:o,deltaY:n,offsetX:a,offsetY:u,direction:d,isVertical:p,isHorizontal:S}}function U(e){const s="scrollTop"in e?e.scrollTop:e.pageYOffset;return Math.max(s,0)}const X=e=>e.stopPropagation();function Y(e,s){(typeof e.cancelable!="boolean"||e.cancelable)&&e.preventDefault(),s&&X(e)}const V=(e,s,o)=>{let n=null;const a=t.computed(()=>e.horizontal?"offsetWidth":"offsetHeight"),u=()=>s.value?s.value[a.value]:0,d=()=>{const{event:p,uniqueKey:S,hasInitial:g}=e;o(p,S,u(),g)};t.onMounted(()=>{typeof ResizeObserver<"u"&&(n=new ResizeObserver(()=>{d()}),s.value&&n.observe(s.value))}),t.onUpdated(()=>{d()}),t.onUnmounted(()=>{n&&(n.disconnect(),n=null)})};function j(e){let s;t.onMounted(()=>{e(),t.nextTick(()=>{s=!0})}),t.onActivated(()=>{s&&e()})}function W(e,s,o={}){if(!window)return;const{target:n=window,passive:a=!1,capture:u=!1}=o;let d=!1,p;const S=c=>{if(d)return;const l=t.unref(c);l&&!p&&(l.addEventListener(e,s,{capture:u,passive:a}),p=!0)},g=c=>{if(d)return;const l=t.unref(c);l&&p&&(l.removeEventListener(e,s,u),p=!1)};t.onUnmounted(()=>g(n)),t.onDeactivated(()=>g(n)),j(()=>S(n));let E;return t.isRef(n)&&(E=t.watch(n,(c,l)=>{g(l),S(c)})),()=>{E==null||E(),g(n),d=!0}}const G={key:0,class:"pull-refresh_text"},J={key:1,class:"loading"},Q=t.defineComponent({__name:"PullRefresh",props:{disabled:{type:Boolean},modelValue:{type:Boolean},headHeight:{default:50},successText:null,pullingText:null,loosingText:null,loadingText:null,pullDistance:null,successDuration:{default:500},animationDuration:{default:300}},emits:["change","refresh","update:modelValue"],setup(e,{emit:s}){const o=e,n=50,a=["pulling","loosing","success"],u={normal:"",loading:"",success:"",pulling:"下拉即可刷新...",loosing:"释放即可刷新..."},d=t.useSlots();let p;const S=t.ref(),g=t.ref(),E=K(S),c=t.reactive({status:"normal",distance:0,duration:0}),l=$(),T=t.computed(()=>({transitionDuration:`${c.duration}ms`,transform:c.distance?`translate3d(0,${c.distance}px, 0)`:""})),I=()=>{if(o.headHeight!==n)return{height:`${o.headHeight}px`}},B=()=>c.status!=="loading"&&c.status!=="success"&&!o.disabled,M=r=>{const y=+(o.pullDistance||o.headHeight);return r>y&&(r<y*2?r=y+(r-y)/2:r=y*1.5+(r-y*2)/4),Math.round(r)},k=(r,y)=>{const i=+(o.pullDistance||o.headHeight);c.distance=r,y?c.status="loading":r===0?c.status="normal":r<i?c.status="pulling":c.status="loosing",s("change",{status:c.status,distance:r})},b=()=>{const{status:r}=c;return r==="normal"?"":o[`${r}Text`]||u[r]},q=()=>{c.status="success",setTimeout(()=>{k(0)},+o.successDuration)},F=r=>{p=U(E.value)===0,p&&(c.duration=0,l.start(r))},D=r=>{B()&&F(r)},P=r=>{if(B()){p||F(r);const{deltaY:y}=l;l.move(r),p&&y.value>=0&&l.isVertical()&&(Y(r),k(M(y.value)))}},O=()=>{p&&l.deltaY.value&&B()&&(c.duration=+o.animationDuration,c.status==="loosing"?(k(+o.headHeight,!0),s("update:modelValue",!0),t.nextTick(()=>s("refresh"))):k(0))};return t.watch(()=>o.modelValue,r=>{c.duration=+o.animationDuration,r?k(+o.headHeight,!0):d.success||o.successText?q():k(0,!1)}),W("touchmove",P,{target:g}),(r,y)=>(t.openBlock(),t.createElementBlock("div",{ref_key:"root",ref:S,class:"pull-refresh"},[t.createElementVNode("div",{ref_key:"track",ref:g,class:"pull-refresh__track",style:t.normalizeStyle(t.unref(T)),"on:touchstartPassive":D,onTouchend:O,onTouchcancel:O},[t.createElementVNode("div",{class:"pull-refresh__head",style:t.normalizeStyle(I())},[t.renderSlot(r.$slots,c.status,{},()=>[a.includes(c.status)?(t.openBlock(),t.createElementBlock("div",G,t.toDisplayString(b()),1)):t.createCommentVNode("",!0),c.status==="loading"?(t.openBlock(),t.createElementBlock("div",J)):t.createCommentVNode("",!0)])],4),t.renderSlot(r.$slots,"default")],36)],512))}}),oe="";var H=2,Z=class{constructor(e,s){z(this,"callUpdate");z(this,"param",{keeps:30,extraProps:{},estimateSize:50,slotHeaderSize:10,uniqueIds:[],buffer:5});z(this,"uniqueIds",[]);z(this,"sizes",new Map);z(this,"firstRangeTotalSize",0);z(this,"firstRangeAverageSize",0);z(this,"lastCalcIndex",0);z(this,"fixedSizeValue",0);z(this,"calcType","INIT");z(this,"offset",0);z(this,"direction","");z(this,"range",Object.create(null));console.log("init",e),this.init(e,s)}init(e,s){this.param=Object.assign({},this.param,e),this.callUpdate=s,this.uniqueIds=this.param.uniqueIds,e&&this.checkRange(0,e.keeps-1)}setUniqueIds(e=[]){this.uniqueIds=e}destroy(){this.init(null,null)}getRange(){const e=Object.create(null);return this.range&&(e.start=this.range.start,e.end=this.range.end,e.padFront=this.range.padFront,e.padBehind=this.range.padBehind),e}isBehind(){return this.direction==="BEHIND"}isFront(){return this.direction==="FRONT"}getOffset(e){return(e<1?0:this.getIndexOffset(e))+this.param.slotHeaderSize}updateParam(e,s){this.param&&e in this.param&&(e==="uniqueIds"&&(this.sizes.forEach((o,n)=>{s.includes(n)||this.sizes.delete(n)}),this.uniqueIds=s),this.param[e]=s)}saveSize(e,s){this.sizes.set(e,s),this.calcType==="INIT"?(this.fixedSizeValue=s,this.calcType="FIXED"):this.calcType==="FIXED"&&this.fixedSizeValue!==s&&(this.calcType="DYNAMIC",delete this.fixedSizeValue),this.calcType!=="FIXED"&&typeof this.firstRangeTotalSize<"u"&&(this.sizes.size<Math.min(this.param.keeps,this.uniqueIds.length)?(this.firstRangeTotalSize=[...this.sizes.values()].reduce((o,n)=>o+n,0),this.firstRangeAverageSize=Math.round(this.firstRangeTotalSize/this.sizes.size)):delete this.firstRangeTotalSize)}handleDataSourcesChange(){let e=this.range.start;this.isFront()?e=e-H:this.isBehind()&&(e=e+H),e=Math.max(e,0),this.updateRange(this.range.start,this.getEndByStart(e))}handleSlotSizeChange(){this.handleDataSourcesChange()}handleScroll(e){this.direction=e<this.offset?"FRONT":"BEHIND",this.offset=e,console.log(this.param),this.param&&(console.log(this.direction),this.direction==="FRONT"?this.handleFront():this.direction==="BEHIND"&&this.handleBehind())}handleFront(){var o;const e=this.getScrollOvers();if(console.log("🚀 ~ file: index.ts:225 ~ Virtual ~ handleBehind ~ overs:",e,this.range,(o=this.param)==null?void 0:o.buffer),e>this.range.start)return;const s=Math.max(e-this.param.buffer,0);this.checkRange(s,this.getEndByStart(s))}handleBehind(){var s;const e=this.getScrollOvers();console.log("🚀 ~ file: index.ts:225 ~ Virtual ~ handleBehind ~ overs:",e,this.range,(s=this.param)==null?void 0:s.buffer),!(e<this.range.start+this.param.buffer)&&this.checkRange(e,this.getEndByStart(e))}getScrollOvers(){const e=this.offset-this.param.slotHeaderSize;if(e<=0)return 0;if(this.isFixedType())return Math.floor(e/this.fixedSizeValue);let s=0,o=0,n=0,a=this.uniqueIds.length;for(;s<=a;){if(o=s+Math.floor((a-s)/2),n=this.getIndexOffset(o),n===e)return o;n<e?s=o+1:n>e&&(a=o-1)}return s>0?--s:0}getIndexOffset(e){if(!e)return 0;let s=0,o=0;for(let n=0;n<e;n++)o=this.sizes.get(this.uniqueIds[n]),s=s+(typeof o=="number"?o:this.getEstimateSize());return this.lastCalcIndex=Math.max(this.lastCalcIndex,e-1),this.lastCalcIndex=Math.min(this.lastCalcIndex,this.getLastIndex()),s}isFixedType(){return this.calcType==="FIXED"}getLastIndex(){return this.uniqueIds.length-1}checkRange(e,s){const o=this.param.keeps,n=this.uniqueIds.length;console.log(this.param,o,n,s-e<o-1),n<=o?(e=0,s=this.getLastIndex()):s-e<o-1&&(e=s-o+1),console.log(this.range,e),this.range.start!==e&&(console.log("==+++++++++++++================="),this.updateRange(e,s))}updateRange(e,s){this.range&&(this.range.start=e,this.range.end=s,this.range.padFront=this.getPadFront(),this.range.padBehind=this.getPadBehind(),this.callUpdate(this.getRange()))}getEndByStart(e){const s=e+this.param.keeps-1;return Math.min(s,this.getLastIndex())}getPadFront(){return this.isFixedType()?this.fixedSizeValue*this.range.start:this.getIndexOffset(this.range.start)}getPadBehind(){const e=this.range.end,s=this.getLastIndex();return console.log("getPadBehind",e,s,this.lastCalcIndex===s,this.getEstimateSize()),this.isFixedType()?(s-e)*this.fixedSizeValue:this.lastCalcIndex===s?this.getIndexOffset(s)-this.getIndexOffset(e):(s-e)*this.getEstimateSize()}getEstimateSize(){return this.isFixedType()?this.fixedSizeValue:this.firstRangeAverageSize||this.param.estimateSize}};const N=t.defineComponent({__name:"SlotWrap",props:{event:null,uniqueKey:null,horizontal:{type:Boolean}},emits:["slotResize"],setup(e,{emit:s}){const o=e,n=t.ref(null);return V(o,n,s),(a,u)=>(t.openBlock(),t.createElementBlock("div",{key:e.uniqueKey,ref_key:"rootRef",ref:n},[t.renderSlot(a.$slots,"default")]))}}),ee=t.defineComponent({__name:"VirtualListItem",props:{index:null,event:null,horizontal:{type:Boolean,default:!1},source:null,uniqueKey:null,extraProps:{default:()=>({})},scopedSlots:{default:()=>({})},component:null},emits:["itemResize"],setup(e,{emit:s}){const o=e;t.computed(()=>o.component);const n=t.ref(null);V(o,n,s);const a=t.computed(()=>{const{component:u,extraProps:d={},index:p,source:S,scopedSlots:g={},uniqueKey:E}=o;return{...d,scopedSlots:g,source:S,index:p}});return(u,d)=>(t.openBlock(),t.createElementBlock("div",{ref_key:"rootRef",ref:n,key:e.uniqueKey},[t.renderSlot(u.$slots,"default",t.mergeProps(t.unref(a),{scopedSlots:e.scopedSlots}))]))}});var _=(e=>(e.ITEM="itemResize",e.SLOT="slotResize",e))(_||{}),C=(e=>(e.HEADER="thead",e.FOOTER="tfoot",e))(C||{});const te=t.defineComponent({__name:"VisualList",props:{dataKey:null,dataSources:{default:()=>[]},keeps:{default:30},extraProps:null,estimateSize:{default:50},direction:{default:"vertical"},start:{default:0},offset:{default:0},topThreshold:{default:0},bottomThreshold:{default:0},pageMode:{type:Boolean,default:!1},wrapClass:{default:"wrap"},wrapStyle:null,headClass:null,footerClass:null},emits:["scroll","totop","tobottom"],setup(e,{expose:s,emit:o}){const n=e;let a;const u=n.direction==="horizontal",d=t.ref(null),p=()=>{const{dataKey:i,dataSources:f=[]}=n;return f.map(h=>typeof i=="function"?i(h):h[i])},S=i=>{console.log("==============",d),d.value=i},g=()=>{a=new Z({slotHeaderSize:0,keeps:n.keeps,estimateSize:n.estimateSize,buffer:Math.round(n.keeps/3),uniqueIds:p(),extraProps:{}},S),d.value=a.getRange()};t.watch(()=>n.dataSources.length,()=>{a.updateParam("uniqueIds",p()),a.handleDataSourcesChange()});const E=t.computed(()=>{const i=[];for(let f=d.value.start;f<=d.value.end;f++){const h=n.dataSources[f];if(h){const x=typeof n.dataKey=="function"?n.dataKey(h):h[n.dataKey];(typeof x=="string"||typeof x=="number")&&i.push({index:f,uniqueKey:x,...h})}}return i}),c=i=>a.sizes.get(i),l=t.ref(),T=u?"scrollLeft":"scrollTop",I=()=>n.pageMode?document.documentElement[T]||document.body[T]:l.value?Math.ceil(l.value[T]):0,B=()=>{const i=u?"clientWidth":"clientHeight";return n.pageMode?document.documentElement[i]||document.body[i]:l.value?Math.ceil(l.value[i]):0},M=()=>{const i=u?"scrollWidth":"scrollHeight";return n.pageMode?document.documentElement[i]||document.body[i]:l.value?Math.ceil(l.value[i]):0},k=(i,f,h,x)=>{o("scroll",x,a.getRange()),a.isFront()&&n.dataSources.length&&i-n.topThreshold<=0?o("totop"):a.isBehind()&&i+f+n.bottomThreshold>=h&&o("tobottom")},b=i=>{const f=I(),h=B(),x=M();f<0||f+h>x+1||!x||(console.log("scroll ing",f),a.handleScroll(f),k(f,h,x,i))};t.onBeforeMount(()=>{g()}),t.onActivated(()=>{D(a.offset)}),t.onMounted(()=>{n.start?F(n.start):n.offset&&D(n.offset),n.pageMode&&(r(),document.addEventListener("scroll",b,{passive:!1}))}),t.onUnmounted(()=>{a.destroy(),n.pageMode&&document.removeEventListener("scroll",b)});const q=(i,f,h)=>{i===C.HEADER?a.updateParam("slotHeaderSize",f):C.FOOTER,h&&a.handleSlotSizeChange()},F=i=>{if(i>=n.dataSources.length-1)O();else{const f=a.getOffset(i);D(f)}},D=i=>{n.pageMode?(document.body[T]=i,document.documentElement[T]=i):l.value&&(l.value[T]=i)},P=t.ref(null),O=()=>{if(P.value){const i=P.value[u?"offsetLeft":"offsetTop"];D(i),setTimeout(()=>{I()+B()<M()&&O()},3)}},r=()=>{if(l.value){const i=l.value.getBoundingClientRect(),{defaultView:f}=l.value.ownerDocument,h=u?i.left+f.pageXOffset:i.top+f.pageYOffset;a.updateParam("slotHeaderSize",h)}};return s({scrollToBottom:O,getSizes:()=>a.sizes.size,getSize:c,getOffset:I,getScrollSize:M,getClientSize:B,scrollToOffset:D,scrollToIndex:F}),(i,f)=>(t.openBlock(),t.createElementBlock("div",{ref_key:"root",ref:l,onScroll:b},[t.renderSlot(i.$slots,"header",{},()=>[t.createVNode(N,{class:t.normalizeClass(e.headClass),event:t.unref(_).SLOT,"unique-key":t.unref(C).HEADER,onSlotResize:q},null,8,["class","event","unique-key"])]),t.createElementVNode("div",{class:t.normalizeClass(e.wrapClass),style:t.normalizeStyle(e.wrapStyle)},[(t.openBlock(!0),t.createElementBlock(t.Fragment,null,t.renderList(t.unref(E),(h,x)=>(t.openBlock(),t.createBlock(ee,{index:h.index,event:t.unref(_).ITEM,horizontal:u,"unique-key":h.uniqueKey,source:h.dataSource,"extra-props":e.extraProps},{default:t.withCtx(()=>[t.renderSlot(i.$slots,"default",t.normalizeProps(t.guardReactiveProps({source:h})))]),_:2},1032,["index","event","unique-key","source","extra-props"]))),256))],6),t.renderSlot(i.$slots,"footer",{},()=>[t.createVNode(N,{class:t.normalizeClass(e.footerClass),event:t.unref(_).SLOT,"unique-key":t.unref(C).FOOTER,onSlotResize:q},null,8,["class","event","unique-key"])]),t.createElementVNode("div",{ref_key:"shepherd",ref:P,style:t.normalizeStyle({width:u?"0px":"100%",height:u?"100%":"0px"})},null,4)],544))}});m.PullRefresh=Q,m.VirsualList=te,Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});
